#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "$0")/.." && pwd)"
cd "$ROOT_DIR"

source "./scripts/_lib.sh"

run_check() {
  py_script="
import os, re, sys
mig_dir = 'apps/server/src/main/resources/db/migration'
if not os.path.exists(mig_dir):
    print(f'SKIP: {mig_dir} does not exist')
    sys.exit(0)

pattern = re.compile(r'^V\d{14}__[a-z0-9_]+\.sql$')
failed = False
for f in os.listdir(mig_dir):
    if f == '.gitkeep': continue
    if not pattern.match(f):
        print(f'ERROR: Invalid migration filename: {f}')
        failed = True

if failed:
    sys.exit(1)
print(f'OK: Checked {mig_dir}')
"
  python3 -c "$py_script"
}

ai_team_run_logged "migration-check" run_check
